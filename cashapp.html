<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.45);
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 40px rgba(0,0,0,.40);
      --primary:#10b981;
      --primary2:#34d399;
      --danger:#fb7185;
      --warn:#f59e0b;

      --overlay: rgba(0,0,0,.45);
      --overlay2: rgba(0,0,0,.30);

      --radius:18px;
      --radius2:14px;
      --tap: rgba(255,255,255,.08);
    }

    [data-theme="light"]{
      --bg:#f4f6fa;
      --card:#ffffff;
      --card2:#eef2f7;
      --text:#0f172a;
      --muted:#4b5563;
      --muted2:#6b7280;
      --line:rgba(15,23,42,.10);
      --shadow: 0 10px 24px rgba(15,23,42,.10);
      --primary:#10b981;
      --primary2:#15b981;
      --danger:#ef4444;
      --warn:#f59e0b;

      --overlay: rgba(255,255,255,.60);
      --overlay2: rgba(15,23,42,.22);

      --tap: rgba(15,23,42,.06);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(900px 600px at 20% -10%, rgba(16,185,129,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 0%, rgba(52,211,153,.16), transparent 62%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 720px;
      margin: 0 auto;
      padding: 16px 14px 26px;
      padding-bottom: max(26px, env(safe-area-inset-bottom));
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin: 6px 2px 14px;
    }
    .title{
      line-height:1.1;
    }
    .title h1{
      font-size: 22px;
      margin:0 0 6px;
      letter-spacing:-.2px;
    }
    .title .sub{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .statusLine{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--card2);
      color: var(--muted);
      font-weight: 700;
    }
    .statusLine.is-error{
      color: var(--danger);
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
    }
    .statusLine.is-success{
      color: var(--primary);
      border-color: rgba(16,185,129,.35);
      background: rgba(16,185,129,.12);
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border: 1px solid var(--line);
      background: var(--card2);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
    }

    .actions{
      display:flex; gap:10px; align-items:center;
    }
    .iconBtn{
      width:42px;height:42px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: var(--card);
      display:grid; place-items:center;
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .iconBtn:active{ transform: scale(.98); background: var(--tap); }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .cardPad{ padding: 14px; }

    .seg{
      display:flex;
      gap: 8px;
      padding: 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: var(--card2);
    }
    .seg button{
      flex:1;
      border:0;
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 700;
      font-size: 13px;
      color: var(--muted);
      background: transparent;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .seg button.active{
      color: var(--text);
      background: rgba(16,185,129,.16);
      border: 1px solid rgba(16,185,129,.25);
      box-shadow: 0 10px 18px rgba(16,185,129,.12);
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .field{
      flex:1;
      min-width: 160px;
    }
    .label{
      font-size:12px;
      color: var(--muted);
      margin: 6px 2px 6px;
      font-weight:700;
    }

    /* --- Fancy Dropdown (portal, no clipping) --- */
    .dropdown{ position:relative; }
    .ddTrigger{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background: var(--card);
      color: var(--text);
      font-weight: 800;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .ddTrigger:active{ background: var(--tap); transform: scale(.99); }
    .ddValue{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .ddChevron{
      width: 20px; height: 20px; flex: 0 0 auto;
      opacity:.8;
      transition: transform .18s ease;
    }
    .dropdown.open .ddChevron{ transform: rotate(180deg); }

    .ddPortal{
      position:fixed;
      inset:0;
      z-index: 9999;
      background: var(--overlay2);
      backdrop-filter: blur(16px) saturate(1.2);
      -webkit-backdrop-filter: blur(16px) saturate(1.2);
    }
    .ddPanel{
      position:fixed;
      min-width: 240px;
      max-width: min(560px, calc(100vw - 24px));
      border-radius: 16px;
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateY(-6px) scale(.985);
      opacity: 0;
      transition: transform .18s ease, opacity .18s ease;
    }
    .ddPanel.show{ transform: translateY(0) scale(1); opacity: 1; }
    .ddList{ max-height: min(52vh, 360px); overflow:auto; padding: 8px; }
    .ddOpt{
      width:100%;
      text-align:left;
      border:0;
      background: transparent;
      color: var(--text);
      font-weight: 800;
      padding: 12px 12px;
      border-radius: 12px;
      cursor:pointer;
    }
    .ddOpt small{ display:block; font-weight:700; color: var(--muted); margin-top: 2px; }
    .ddOpt:hover{ background: rgba(16,185,129,.12); }
    .ddOpt:active{ background: rgba(16,185,129,.18); }

    /* --- Buttons --- */
    .btn{
      border:0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-height: 44px;
      white-space:nowrap;
    }
    .btnPrimary{
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      color:#fff;
      box-shadow: 0 14px 26px rgba(21,185,129,.25);
    }
    .btnGhost{
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--line);
    }
    .btnDanger{
      background: rgba(239,68,68,.12);
      border:1px solid rgba(239,68,68,.25);
      color: var(--danger);
    }
    .btn:active{ transform: scale(.99); }

    .sp12{ height:12px; }
    .sp8{ height:8px; }
    .muted{ color: var(--muted); }
    .small{ font-size: 12px; }

    /* --- List --- */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: var(--card);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .item:active{ background: var(--tap); transform: scale(.995); }
    .itemTop{
      display:flex; justify-content:space-between; gap:10px; align-items:baseline;
      font-weight: 950;
    }
    .itemTop .sum{ font-size: 16px; letter-spacing:-.2px; }
    .itemMeta{
      margin-top: 6px;
      display:flex; gap:10px; flex-wrap:wrap;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .badge{
      padding: 5px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: var(--card2);
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
    }
    .badge.ok{
      color: var(--primary);
      border-color: rgba(16,185,129,.3);
      background: rgba(16,185,129,.12);
    }
    .badge.warn{
      color: var(--warn);
      border-color: rgba(245,158,11,.35);
      background: rgba(245,158,11,.12);
    }
    .badge.danger{
      color: var(--danger);
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
    }

    /* --- Modal / Sheet --- */
    .modalBackdrop{
      position:fixed;
      inset:0;
      z-index: 20000;
      background: var(--overlay2);
      backdrop-filter: blur(18px) saturate(1.2);
      -webkit-backdrop-filter: blur(18px) saturate(1.2);
      display:none;
      padding: 14px;
      padding-top: max(14px, env(safe-area-inset-top));
      padding-bottom: max(14px, env(safe-area-inset-bottom));
    }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width: min(720px, 100%);
      margin: 0 auto;
      border-radius: 22px;
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      max-height: 100%;
    }
    .modalHead{
      padding: 14px 14px 10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      border-bottom: 1px solid var(--line);
    }
    .modalHead .h{
      font-size: 16px;
      font-weight: 950;
      letter-spacing:-.2px;
    }
    .modalBody{
      padding: 14px;
      overflow:auto;
    }
    .closeX{
      border:1px solid var(--line);
      background: var(--card2);
      color: var(--text);
      width: 40px; height: 40px;
      border-radius: 14px;
      display:grid; place-items:center;
      cursor:pointer;
    }
    .closeX:active{ transform: scale(.98); background: var(--tap); }

    /* --- Signature canvas --- */
    .sigWrap{
      border:1px solid var(--line);
      border-radius: 16px;
      overflow:hidden;
      background: var(--card);
    }
    .inputArea{
      width:100%;
      border-radius:16px;
      border:1px solid var(--line);
      background: var(--card);
      color: var(--text);
      padding: 12px 12px;
      font-weight:800;
      outline:none;
      resize: vertical;
    }
    canvas{
      display:block;
      width: 100%;
      height: 160px;
      touch-action: none;
    }

    /* --- Toast --- */
    .toast{
      position:fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: max(18px, env(safe-area-inset-bottom));
      z-index: 30000;
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: var(--card2);
      box-shadow: var(--shadow);
      font-weight: 900;
      display:none;
    }
    .toast.show{ display:block; }

    .hidden{ display:none !important; }

    .participantList{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .participant{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--card2);
      border: 1px solid var(--line);
    }
    .participantName{
      font-weight: 800;
      font-size: 13px;
    }
    .participantMeta{
      font-size: 11px;
      color: var(--muted2);
    }
    .emptyState{
      padding: 12px 10px;
      border-radius: 14px;
      border: 1px dashed var(--line);
      background: var(--card2);
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö</h1>
        <div class="sub">
          <span id="statusLine" class="statusLine">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶</span>
          <span id="roleChip" class="chip hidden"></span>
        </div>
      </div>
      <div class="actions">
        <button id="themeBtn" class="iconBtn" type="button" title="–¢–µ–º–∞">üåì</button>
        <button id="refreshBtn" class="iconBtn" type="button" title="–û–±–Ω–æ–≤–∏—Ç—å">‚ü≥</button>
      </div>
    </div>

    <div class="card cardPad">
      <div class="seg" role="tablist" aria-label="–†–∞–∑–¥–µ–ª—ã">
        <button id="tabRequests" class="active" type="button" role="tab" aria-selected="true">–ó–∞–ø—Ä–æ—Å—ã</button>
        <button id="tabHistory" type="button" role="tab" aria-selected="false">–ò—Å—Ç–æ—Ä–∏—è</button>
      </div>

      <div class="sp12"></div>

      <!-- Filters -->
      <div class="row">
        <div class="field">
          <div class="label">–°—á—ë—Ç</div>
          <div class="dropdown" data-dd="account">
            <select id="accountSel" class="hidden">
              <option value="">–í—Å–µ</option>
              <option value="main">MAIN ‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–π</option>
              <option value="praise">PRAISE ‚Ä¢ –•–≤–∞–ª–∞</option>
              <option value="alpha">ALPHA ‚Ä¢ –ê–ª—å—Ñ–∞</option>
            </select>
            <button class="ddTrigger" type="button" aria-expanded="false">
              <span class="ddValue" id="accountLabel">–í—Å–µ</span>
              <svg class="ddChevron" viewBox="0 0 24 24" fill="none">
                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="field" style="min-width:210px">
          <div class="label">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å</div>
          <div class="dropdown" data-dd="scope">
            <select id="scopeSel" class="hidden">
              <option value="open">–û–∂–∏–¥–∞—é—Ç –º–æ–µ–π –ø–æ–¥–ø–∏—Å–∏</option>
              <option value="all">–í—Å–µ</option>
            </select>
            <button class="ddTrigger" type="button" aria-expanded="false">
              <span class="ddValue" id="scopeLabel">–û–∂–∏–¥–∞—é—Ç –º–æ–µ–π –ø–æ–¥–ø–∏—Å–∏</span>
              <svg class="ddChevron" viewBox="0 0 24 24" fill="none">
                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="sp12"></div>

      <!-- Lists -->
      <div id="listWrap" class="list"></div>
      <div id="emptyWrap" class="muted small emptyState hidden">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤.</div>
    </div>
  </div>

  <!-- Detail modal -->
  <div id="detailBackdrop" class="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="h" id="detailTitle">–ó–∞–ø—Ä–æ—Å</div>
          <div class="muted small" id="detailSub"></div>
        </div>
        <button id="detailClose" class="closeX" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="modalBody">
        <div id="detailInfo" class="muted small"></div>
        <div class="sp12"></div>

        <div id="sigBlock">
          <div class="label">–ü–æ–¥–ø–∏—Å—å</div>
          <div class="sigWrap">
            <canvas id="sigCanvas"></canvas>
          </div>
          <div class="sp8"></div>
          <div class="row">
            <button id="sigClear" class="btn btnGhost" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button id="sigSend" class="btn btnPrimary" type="button">–ü–æ–¥–ø–∏—Å–∞—Ç—å</button>
          </div>

          <div class="sp12"></div>
          <div class="label">–û—Ç–∫–∞–∑</div>
          <textarea id="refuseReason" rows="3" class="inputArea" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
          <div class="sp8"></div>
          <button id="refuseBtn" class="btn btnDanger" type="button">–û—Ç–∫–∞–∑–∞—Ç—å—Å—è</button>
        </div>

        <div id="finalBlock" class="hidden">
          <div class="badge">–í—ã —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å</div>
        </div>

      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /**********************
     * Theme
     **********************/
    function detectTelegramTheme(){
      try{
        const tg = window.Telegram && window.Telegram.WebApp;
        const p = tg && tg.themeParams;
        const bg = p && (p.bg_color || p.secondary_bg_color);
        if (!bg) return null;
        // crude brightness check
        const c = bg.replace('#','');
        if (c.length !== 6) return null;
        const r = parseInt(c.slice(0,2),16);
        const g = parseInt(c.slice(2,4),16);
        const b = parseInt(c.slice(4,6),16);
        const lum = (0.2126*r + 0.7152*g + 0.0722*b);
        return lum < 130 ? "dark" : "light";
      }catch{ return null; }
    }
    function applyTheme(theme){
      document.documentElement.dataset.theme = theme;
      localStorage.setItem("cashapp_theme", theme);
      // recolor canvas stroke
      if (Pad.ctx){
        Pad.ctx.strokeStyle = theme === "dark" ? "#eaf0ff" : "#0f172a";
      }
    }
    function initTheme(){
      const saved = localStorage.getItem("cashapp_theme");
      if (saved === "light" || saved === "dark"){
        applyTheme(saved);
        return;
      }
      const tgTheme = detectTelegramTheme();
      if (tgTheme){
        applyTheme(tgTheme);
        return;
      }
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      applyTheme(prefersDark ? "dark" : "light");
    }

    /**********************
     * API helper
     **********************/
    const API = {
      baseUrl: "",
      token: null,
      setToken(token){
        this.token = token || null;
        if (token){
          localStorage.setItem("cashapp_token", token);
        }
      },
      clearToken(){
        this.token = null;
        localStorage.removeItem("cashapp_token");
      },
      async req(method, path, body){
        const headers = { "Content-Type": "application/json" };
        if (this.token){
          headers.Authorization = `Bearer ${this.token}`;
        }
        const res = await fetch(this.baseUrl + path, {
          method,
          headers,
          credentials: "include",
          body: body ? JSON.stringify(body) : undefined,
        });
        const txt = await res.text();
        let data = null;
        try{ data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
        if (!res.ok){
          if (res.status === 401){
            this.clearToken();
            throw new Error("–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram");
          }
          if (res.status === 403){
            throw new Error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞");
          }
          const msg = (data && data.detail) ? data.detail : (typeof data === "string" ? data : "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞");
          throw new Error(msg);
        }
        return data;
      },
      get(p){ return this.req("GET", p); },
      post(p,b){ return this.req("POST", p, b); },
    };

    /**********************
     * UI helpers
     **********************/
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> t.classList.remove("show"), 2400);
    }

    function fmtMoney(n){
      const x = Number(n||0);
      return x.toLocaleString("ru-RU", {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function fmtAccount(a){
      const v = (a||"").toLowerCase();
      if (v==="main") return "MAIN ‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–π";
      if (v==="praise") return "PRAISE ‚Ä¢ –•–≤–∞–ª–∞";
      if (v==="alpha") return "ALPHA ‚Ä¢ –ê–ª—å—Ñ–∞";
      return a || "‚Äî";
    }
    function fmtOp(t){
      const v = (t||"").toLowerCase();
      if (v==="withdraw") return "–ò–∑—ä—è—Ç–∏–µ";
      if (v==="collect") return "–°–±–æ—Ä";
      return t || "‚Äî";
    }
    function fmtDateTime(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString("ru-RU", {day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit"});
      }catch{ return iso || "‚Äî"; }
    }
    const STATUS_LABELS = {
      PENDING_SIGNERS: "–û–∂–∏–¥–∞—é—Ç –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–æ–≤",
      PENDING_ADMIN: "–û–∂–∏–¥–∞–µ—Ç –∞–¥–º–∏–Ω–∞",
      SIGNED: "–ü–æ–¥–ø–∏—Å–∞–Ω–æ",
      REFUSED: "–û—Ç–∫–∞–∑–∞–Ω–æ",
      CANCELLED: "–û—Ç–º–µ–Ω–µ–Ω–æ",
    };
    function fmtStatus(status){
      const key = String(status || "").toUpperCase();
      return STATUS_LABELS[key] || String(status || "‚Äî").replaceAll("_"," ");
    }
    function statusTone(status){
      const key = String(status || "").toUpperCase();
      if (key.includes("SIGNED") || key.includes("APPROVED")) return "ok";
      if (key.includes("REFUSED") || key.includes("REJECT") || key.includes("CANCEL")) return "danger";
      if (key.includes("PENDING") || key.includes("WAIT")) return "warn";
      return "";
    }

    function setStatus(text, tone){
      const el = $("statusLine");
      el.textContent = text;
      el.classList.toggle("is-error", tone === "error");
      el.classList.toggle("is-success", tone === "success");
    }
    function applyUser(me){
      State.me = me;
      $("roleChip").textContent = `${me.name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"} ‚Ä¢ ${me.role || "‚Äî"}`;
      $("roleChip").classList.remove("hidden");
    }
    /**********************
     * Fancy Dropdown (portal)
     **********************/
    function makeDropdown(selectId, labelId){
      const sel = $(selectId);
      const root = sel.closest(".dropdown");
      const btn = root.querySelector(".ddTrigger");
      const label = $(labelId);

      function syncLabel(){
        const opt = sel.options[sel.selectedIndex];
        label.textContent = opt ? opt.textContent : "‚Äî";
      }

      let portal = null;
      let panel = null;
      let open = false;

      function buildPanel(){
        portal = document.createElement("div");
        portal.className = "ddPortal";
        panel = document.createElement("div");
        panel.className = "ddPanel";
        const list = document.createElement("div");
        list.className = "ddList";

        Array.from(sel.options).forEach((o)=>{
          const b = document.createElement("button");
          b.type = "button";
          b.className = "ddOpt";
          b.dataset.value = o.value;
          b.textContent = o.textContent;
          b.addEventListener("click", ()=>{
            sel.value = o.value;
            sel.dispatchEvent(new Event("change", {bubbles:true}));
            close();
          });
          list.appendChild(b);
        });

        panel.appendChild(list);
        portal.appendChild(panel);
        document.body.appendChild(portal);

        // Close on backdrop click
        portal.addEventListener("click", (e)=>{
          if (e.target === portal) close();
        });
      }

      function position(){
        if (!panel) return;
        const r = btn.getBoundingClientRect();
        const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

        const margin = 10;
        const width = Math.min(Math.max(r.width, 260), vw - margin*2);
        let left = Math.min(Math.max(r.left, margin), vw - width - margin);

        // open up if needed
        const spaceBelow = vh - r.bottom - margin;
        const spaceAbove = r.top - margin;
        const wantHeight = Math.min(360, Math.floor(vh * 0.52));
        const openUp = spaceBelow < 220 && spaceAbove > spaceBelow;

        const maxH = Math.min(wantHeight, openUp ? (spaceAbove - 8) : (spaceBelow - 8));
        panel.style.width = width + "px";
        panel.style.left = left + "px";
        panel.style.maxHeight = Math.max(160, maxH) + "px";
        if (openUp){
          panel.style.top = "auto";
          panel.style.bottom = (vh - r.top + 8) + "px";
        } else {
          panel.style.bottom = "auto";
          panel.style.top = (r.bottom + 8) + "px";
        }
      }

      function show(){
        if (open) return;
        open = true;
        root.classList.add("open");
        btn.setAttribute("aria-expanded","true");
        buildPanel();
        position();
        requestAnimationFrame(()=> panel && panel.classList.add("show"));

        window.addEventListener("resize", position, {passive:true});
        window.addEventListener("scroll", position, {passive:true});
        document.addEventListener("keydown", onKey);
      }

      function close(){
        if (!open) return;
        open = false;
        root.classList.remove("open");
        btn.setAttribute("aria-expanded","false");
        window.removeEventListener("resize", position);
        window.removeEventListener("scroll", position);
        document.removeEventListener("keydown", onKey);

        if (panel) panel.classList.remove("show");
        const p = portal;
        portal = null; panel = null;
        setTimeout(()=>{
          if (p && p.parentNode) p.parentNode.removeChild(p);
        }, 180);
      }

      function onKey(e){
        if (e.key === "Escape") close();
      }

      btn.addEventListener("click", (e)=>{
        e.preventDefault();
        e.stopPropagation();
        open ? close() : show();
      });

      sel.addEventListener("change", syncLabel);
      syncLabel();
      return { close, syncLabel };
    }

    /**********************
     * Signature pad
     **********************/
    const Pad = {
      canvas: null,
      ctx: null,
      drawing: false,
      last: null,
      init(){
        this.canvas = $("sigCanvas");
        this.ctx = this.canvas.getContext("2d");

        const resize = ()=>{
          const rect = this.canvas.getBoundingClientRect();
          const dpr = window.devicePixelRatio || 1;
          this.canvas.width = Math.max(1, Math.floor(rect.width * dpr));
          this.canvas.height = Math.max(1, Math.floor(rect.height * dpr));
          this.ctx.setTransform(dpr,0,0,dpr,0,0);
          this.ctx.lineWidth = 2.4;
          this.ctx.lineCap = "round";
          this.ctx.strokeStyle = document.documentElement.dataset.theme === "dark" ? "#eaf0ff" : "#0f172a";
        };

        const pos = (e)=>{
          const rect = this.canvas.getBoundingClientRect();
          return { x: (e.clientX - rect.left), y: (e.clientY - rect.top) };
        };

        const start = (e)=>{ this.drawing = true; this.last = pos(e); };
        const move = (e)=>{
          if (!this.drawing) return;
          const p = pos(e);
          this.ctx.beginPath();
          this.ctx.moveTo(this.last.x, this.last.y);
          this.ctx.lineTo(p.x, p.y);
          this.ctx.stroke();
          this.last = p;
        };
        const end = ()=>{ this.drawing = false; this.last = null; };

        this.canvas.addEventListener("pointerdown", (e)=>{ this.canvas.setPointerCapture(e.pointerId); start(e); });
        this.canvas.addEventListener("pointermove", move);
        this.canvas.addEventListener("pointerup", end);
        this.canvas.addEventListener("pointercancel", end);

        window.addEventListener("resize", resize);
        setTimeout(resize, 0);
      },
      clear(){
        if (!this.ctx) return;
        this.ctx.clearRect(0,0,this.canvas.width, this.canvas.height);
      },
      dataUrl(){
        return this.canvas.toDataURL("image/png");
      }
    };

    /**********************
     * State + screens
     **********************/
    const State = {
      me: null,
      tab: "requests",
      currentId: null,
      dropdowns: {},
    };

    function setTab(tab){
      State.tab = tab;
      $("tabRequests").classList.toggle("active", tab==="requests");
      $("tabHistory").classList.toggle("active", tab==="history");
      $("tabRequests").setAttribute("aria-selected", tab==="requests" ? "true":"false");
      $("tabHistory").setAttribute("aria-selected", tab==="history" ? "true":"false");
      loadList().catch(e=> toast(String(e.message||e)));
    }

    function showDetail(show){
      const b = $("detailBackdrop");
      b.classList.toggle("show", !!show);
      b.setAttribute("aria-hidden", show ? "false":"true");
      document.body.style.overflow = show ? "hidden" : "";
    }

    async function loadList(){
      $("emptyWrap").classList.add("hidden");
      $("listWrap").innerHTML = '<div class="muted small">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';

      const account = $("accountSel").value || "";
      const scope = $("scopeSel").value || "open";

      const q = new URLSearchParams();
      if (account) q.set("account", account);
      q.set("only_open", scope === "open" ? "true" : "false");

      const data = await API.get(`/api/cashflow/requests/my?${q.toString()}`);
      const items = (data && data.items) ? data.items : [];

      if (!items.length){
        $("listWrap").innerHTML = "";
        $("emptyWrap").classList.remove("hidden");
        return;
      }

      $("listWrap").innerHTML = "";
      for (const it of items){
        const el = document.createElement("div");
        el.className = "item";
        const tone = statusTone(it.status);
        el.innerHTML = `
          <div class="itemTop">
            <div class="sum">${fmtMoney(it.amount)} ‚ÇΩ</div>
            <span class="badge ${tone}">${fmtStatus(it.status)}</span>
          </div>
          <div class="itemMeta">
            <span>${fmtOp(it.op_type)}</span>
            <span>‚Ä¢</span>
            <span>${fmtAccount(it.account)}</span>
            <span>‚Ä¢</span>
            <span>${fmtDateTime(it.created_at)}</span>
          </div>
        `;
        el.addEventListener("click", ()=> openDetail(it.id));
        $("listWrap").appendChild(el);
      }
    }

    async function openDetail(id){
      State.currentId = id;
      showDetail(true);
      $("detailInfo").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
      $("detailSub").textContent = "";
      $("finalBlock").classList.add("hidden");
      $("sigBlock").classList.remove("hidden");
      Pad.clear();

      const view = await API.get(`/api/cashflow/requests/${encodeURIComponent(id)}`);
      const req = view.request;
      const participants = view.participants || [];

      $("detailTitle").textContent = `${fmtOp(req.op_type)} ‚Ä¢ ${fmtAccount(req.account)}`;
      $("detailSub").textContent = `${fmtMoney(req.amount)} ‚ÇΩ ‚Ä¢ ${fmtDateTime(req.created_at)} ‚Ä¢ ${fmtStatus(req.status)}`;

      // check my state
      const myId = State.me ? Number(State.me.telegram_id) : null;
      const mePart = participants.find(p=> Number(p.telegram_id) === myId);
      const myState = mePart ? (mePart.state || mePart.status || "") : "";
      const already = String(myState||"").toUpperCase().includes("SIGNED") || String(myState||"").toUpperCase().includes("REFUSED");
      if (already){
        $("sigBlock").classList.add("hidden");
        $("finalBlock").classList.remove("hidden");
      }

      let infoHtml = `
        <div><b>–ó–∞–ø—Ä–æ—Å #${req.id}</b></div>
        <div class="sp8"></div>
        <div class="muted small">–£—á–∞—Å—Ç–Ω–∏–∫–∏:</div>
        <div class="sp8"></div>
        <div class="participantList">
      `;
      for (const p of participants){
        const state = p.state || p.status || "";
        const tone = statusTone(state);
        infoHtml += `
          <div class="participant">
            <div>
              <div class="participantName">${p.name_snapshot || "‚Äî"}</div>
              <div class="participantMeta">ID ${p.telegram_id || "‚Äî"}</div>
            </div>
            <span class="badge ${tone}">${fmtStatus(state)}</span>
          </div>
        `;
      }
      infoHtml += "</div>";
      $("detailInfo").innerHTML = infoHtml;
    }

    async function signCurrent(){
      const id = State.currentId;
      if (!id) return;
      const sig = Pad.dataUrl();
      await API.post(`/api/cashflow/requests/${encodeURIComponent(id)}/sign`, { signature_data_url: sig });
      toast("–ü–æ–¥–ø–∏—Å–∞–Ω–æ");
      showDetail(false);
      await loadList();
    }

    async function refuseCurrent(){
      const id = State.currentId;
      if (!id) return;
      const reason = ($("refuseReason").value || "").trim();
      if (!reason){
        toast("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞");
        return;
      }
      await API.post(`/api/cashflow/requests/${encodeURIComponent(id)}/refuse`, { reason });
      toast("–û—Ç–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
      showDetail(false);
      await loadList();
    }

    /**********************
     * Auth + init
     **********************/
    async function authTelegram(){
      const tg = window.Telegram && window.Telegram.WebApp;
      if (!tg){
        setStatus("–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram", "error");
        return null;
      }
      try{
        tg.expand && tg.expand();
      }catch{}
      const initData = tg.initData || "";
      if (!initData){
        setStatus("–ù–µ—Ç initData", "error");
        return null;
      }
      setStatus("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è‚Ä¶");
      const res = await API.post("/api/auth/telegram", { initData });
      return res;
    }

    async function loadMe(){
      const me = await API.get("/api/me");
      applyUser(me);
      setStatus("–ì–æ—Ç–æ–≤–æ", "success");
      return me;
    }

    async function ensureAuth(){
      const stored = localStorage.getItem("cashapp_token");
      if (stored){
        API.setToken(stored);
        try{
          await loadMe();
          return true;
        }catch{
          API.clearToken();
        }
      }
      const res = await authTelegram();
      if (!res || !res.token){
        return false;
      }
      API.setToken(res.token);
      if (res.user){
        applyUser(res.user);
        setStatus("–ì–æ—Ç–æ–≤–æ", "success");
      } else {
        await loadMe();
      }
      return true;
    }

    // bind
    $("tabRequests").addEventListener("click", ()=> setTab("requests"));
    $("tabHistory").addEventListener("click", ()=> setTab("history"));

    $("detailClose").addEventListener("click", ()=> showDetail(false));
    $("detailBackdrop").addEventListener("click", (e)=>{ if (e.target === $("detailBackdrop")) showDetail(false); });

    $("sigClear").addEventListener("click", ()=> Pad.clear());
    $("sigSend").addEventListener("click", ()=> signCurrent().catch(e=> toast(String(e.message||e))));
    $("refuseBtn").addEventListener("click", ()=> refuseCurrent().catch(e=> toast(String(e.message||e))));

    $("refreshBtn").addEventListener("click", ()=>{
      ensureAuth()
        .then((ok)=> ok ? loadList() : Promise.resolve())
        .then(()=> toast("–û–±–Ω–æ–≤–ª–µ–Ω–æ"))
        .catch(e=> toast(String(e.message||e)));
    });

    $("themeBtn").addEventListener("click", ()=>{
      const cur = document.documentElement.dataset.theme === "dark" ? "dark" : "light";
      applyTheme(cur === "dark" ? "light" : "dark");
    });

    (async function init(){
      initTheme();
      Pad.init();

      State.dropdowns.account = makeDropdown("accountSel", "accountLabel");
      State.dropdowns.scope = makeDropdown("scopeSel", "scopeLabel");

      try{
        const ok = await ensureAuth();
        if (ok){
          await loadList();
        } else {
          $("listWrap").innerHTML = "";
          $("emptyWrap").textContent = "–ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram.";
          $("emptyWrap").classList.remove("hidden");
        }
      }catch(e){
        setStatus("–û—à–∏–±–∫–∞", "error");
        toast(String(e.message||e));
      }
    })();
  </script>
</body>
</html>
